---
title: "Initial data analysis with nflverse packages"
output: html_notebook
---


```{r libraries, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(nflverse)
library(gt)
```

```{r player_stats, include=TRUE}
player_stats <- nflreadr::load_player_stats(seasons = most_recent_season(),
                                            stat_type = "offense")
```

`nflreadr::load_player_stats()`. Arguments include:

* `seasons=`: numeric vector, or use the `most_recent_season()` function
* `stat_type=`: takes "offense", "defense", or "kicking"
*  `file_type=`: takes "rds" (default), "qs", "csv", or "parquet"


From the book:

> As an example, let’s say you need to get Patrick Mahomes’ total passing yard and attempts from the 2022 season. You could do so via load_pbp() but, if you do not need further context (such as down, distance, quarter, etc.), using load_player_stats() is much more efficient.

Below, I'm taking the weekly, box-score level receiving stats, and summarizing them for the pass catchers for the Steelers.

```{r}
player_stats %>% names()
```


```{r}
player_stats %>% 
  filter(recent_team == 'PIT',
         position %in% c('WR', 'RB', 'TE')) %>% 
  rename(receiving_receptions = receptions,
         receiving_targets = targets,
         receiving_racr = racr,
         receiving_air_yards_share = air_yards_share,
         receiving_target_share = target_share) %>% 
  select(player_display_name, position, starts_with("receiving")) %>% 
  group_by(player_display_name, position) %>% 
  # summarize(across(starts_with("receiving"), mean, na.rm = TRUE))
  summarise(
    across(
      starts_with("receiving"),
      list(
        mean = ~round(mean(., na.rm = TRUE), 2),
        sum = ~round(sum(., na.rm = TRUE), 2)
      ),
      .names = "{.fn}_{.col}"
    ),
    .groups='drop'
  ) %>% 
  # ungroup() %>% 
  arrange(-sum_receiving_targets) %>% 
  filter(sum_receiving_targets >= 5)
  
```
  
Some of these statistics won't have any meaning summed (or possibly by taking an average), so I'll dig into each one to get clearer on that.
  
This looks like a good article on [EPA](https://bestballstats.com/expected-points-added-a-full-explanation/#:~:text=Expected%20Points%20Added%20(EPA)%20is,evaluate%20team%20and%20player%20performance.).


## Play by play data

```{r play_by_play_2024, include=TRUE}
play_by_play_2024 <- load_pbp(seasons=most_recent_season())
```

## Average field position

```{r}
play_by_play_2024 %>% 
  # filter(posteam == 'PIT') %>%
  filter(!is.na(down)) %>% 
  group_by(game_id, drive) %>% 
  # Check that slicing takes the first play of each possession
  slice(1) %>% 
  # mutate(play_seq = n()) %>% 
  # select(play_seq, everything())
  ungroup() %>% 
  group_by(posteam) %>% 
  summarise(avg_starting_field_position = 100 - round(mean(yardline_100), 0)) %>% 
  mutate(rank_avg_starting_field_position = dense_rank(-avg_starting_field_position)) %>% 
  arrange(rank_avg_starting_field_position)
  filter(drive == 2) 
```


## Run-Pass split

Here's run-pass split, but it lacks in-game context. If a team is behind, they'll be much more likely to be pass-heavy.

```{r run_pass_split1, include=TRUE}
play_by_play_2024 %>% 
  filter(play_type %in% c('run', 'pass')) %>% 
  # could also add quarter
  group_by(posteam, play_type) %>% 
  tally() %>% 
  mutate(perc_total = round((n / sum(n)) * 100, 1)) %>% 
  arrange(-perc_total)
```

```{r run_pass_split2, include=TRUE}
play_by_play_2024 %>% 
  arrange(-score_differential) %>% 
  # probably an established way to get at this that takes into account time remaining in the game, too
  mutate(within_two_scores = if_else(abs(score_differential) <= 16, 1, 0)) %>% 
  filter(play_type %in% c('run', 'pass'),
         within_two_scores == 1) %>% 
  group_by(posteam, within_two_scores, play_type) %>% 
  tally() %>% 
  mutate(perc_total = round((n / sum(n)) * 100, 1)) %>% 
  arrange(posteam, -perc_total) %>% 
  gt() %>%
  cols_label(play_type = 'Play type',
             n = '# of plays',
             perc_total = '% of total') %>%
  #add table title
  tab_header(title = md("**Run-pass split by NFL teams in the 2024 Season**"),
             subtitle = 'Of plays run within 16 points (ahead or behind)') %>% 
  tab_source_note(source_note = "Data from `nflreadr::` package") %>% 
  #apply new style to all column headers
  tab_style(
    locations = cells_column_labels(columns = everything()),
    style = list(
      #thick border
      cell_borders(sides = "bottom", weight = px(3)),
      #make text bold
      cell_text(weight = "bold")
    )
  ) %>% 
  data_color(columns = c(perc_total),
             colors = viridis::magma(100)) %>% 
  #apply different style to title
  # tab_style(
  #   style = list(
  #     cell_fill(color = "lightblue"),   # Background color
  #     cell_text(weight = "bold")        # Bold text
  #   ),
  #   locations = cells_body(
  #     rows = posteam == "PIT"
  #   )
  # ) %>% 
  opt_all_caps() %>% 
  opt_table_font(
    font = list(
      google_font("Roboto"),
      default_fonts()
    )
  ) %>% 
  tab_options(
    #remove border between column headers and title
    column_labels.border.top.width = px(3),
    column_labels.border.top.color = "transparent",
    #remove border around the table
    table.border.top.color = "transparent",
    table.border.bottom.color = "transparent",
    #adjust font sizes and alignment
    source_notes.font.size = 12,
    heading.align = "left"
  )
```


## Average years per rush / pass play

## Personnel groupings 

## When is George Pickens targeted? 

### Splits

### Downs 

### Quarters 

### Position at snap 

### Redzone 

```{r}
play_by_play_2024 %>%
  filter(play_type == 'pass',
         posteam == 'PIT') %>% 
  # filter(receiver_player_name == 'Di.Johnson') %>%
  # select(touchdown, everything()) 
  # select(contains('catch'))
  mutate(redzone_play = if_else(yardline_100 <= 20, 1, 0),
         short_redzone_play = if_else(yardline_100 <= 10, 1, 0)) %>% 
  # select(touchdown, redzone_play, yardline_100, everything())
  filter(redzone_play == 1) %>% 
         # receiver_player_name == 'Di.Johnson',
         # need to figure out these fields. When I filter out NULL receiver player name, the receiving stats change. Look at Dionte Johnson (he has a receiving TD when I don't filter, but does not when I do)
         # !is.na(receiver_player_name)) %>%
  group_by(posteam, redzone_play, receiver_player_name) %>% 
    # need to add completions...
  summarise(count_targets = n(),
            sum_yards_gained = sum(yards_gained),
            sum_touchdown = sum(touchdown),
            sum_yards_after_catch = sum(yards_after_catch, na.rm = TRUE),
            .groups='drop') %>% 
  arrange(-count_targets)
  
group_by(pass_length, pass_location, game_half, no_huddle)
receiving_years
```


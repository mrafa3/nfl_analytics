---
title: "The 2024 NFL season in 10 graphs"
output: html_notebook
---


```{r setup, include=TRUE, warning=FALSE, message=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
    tidyverse,
    nflverse,
    gt,
    gtExtras,
    gtUtils,
    ggfx,
    rvest,
    httr,
    jsonlite,
    patchwork,
    ggtext,
    ggrepel,
    ggimage,
    dlookr,
    showtext,
    sysfonts,
    janitor,
    grid,
    ggiraph,
    glue,
    here
)    

sysfonts::font_add_google("Lexend")
showtext::showtext_auto()
```

```{r nfl_analytics_theme, include=TRUE}
theme_nfl_analytics <- function(..., base_size = 12) {
  theme(
    text = element_text(family = "Lexend", size = base_size, color = "black", face='bold'),
    axis.ticks = element_blank(),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold"),
    plot.title.position = "plot",
    plot.title = element_markdown(size = 16, vjust = .02, hjust = 0.5),
    plot.subtitle = element_markdown(hjust = 0.5),
    plot.caption = element_markdown(size = 8),
    panel.grid.minor = element_blank(),
    panel.grid.major =  element_line(color = "#d0d0d0"),
    panel.background = element_rect(fill = "#f7f7f7"),
    plot.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_blank(),
    legend.background = element_rect(color = "#F7F7F7"),
    legend.key = element_rect(color = "#F7F7F7"),
    legend.title = element_text(face = "bold", hjust = .5),
    strip.text = element_text(face = "bold"))
}
```

Potential ideas to explore:

* Benching Richardson
* Arthur Smith play action
* Dolphins: with and without Tua
* Regression of Stroud, Rodgers 
* Lions offensive efficiency
* Vikings defensive consistency 


#### Rookie QBs: performance and inconsistency

* Jayden Daniels spotlight

```{r}
pbp_2024 <- load_pbp(seasons = 2024)
ftn_2024 <- load_ftn_charting(seasons = 2024)

pbp_2024 <- pbp_2024 %>% 
  left_join(x=.,
            y=ftn_2024,
            by=c('game_id' = 'nflverse_game_id',
                 'play_id' = 'nflverse_play_id',
                 'season',
                 'week'))
```

```{r params, include=TRUE}
max_week_param <- pbp_2024 %>% 
  summarise(max(week)) %>% 
  pull()
```

```{r}
pbp_2024 %>% 
  select(contains('epa'))
```


```{r}
(rookie_qb_epa_weekly_2024 <- pbp_2024 %>% 
  filter(passer %in% c('J.Daniels', 'C.Williams', 'B.Nix', 'D.Maye')) %>% 
  group_by(game_id, week, posteam, passer, passer_id) %>% 
  summarise(across(
    c('qb_epa', 'pass_attempt', 'air_epa', 'yac_epa'),
    list(
        mean = ~round(mean(., na.rm = TRUE), 2),
        sum = ~round(sum(., na.rm = TRUE), 2)
      ),
      .names = "{.fn}_{.col}"
    ),
    .groups = 'drop') %>% 
  filter(sum_pass_attempt >= 10))
```

```{r}
rookie_qb_epa_weekly_2024 %>% 
  ggplot(.,
         aes(x=week,
             y=mean_qb_epa,
             color=posteam)) + 
  geom_line(linewidth=1.2) + 
  geom_point(data=. %>% filter(week == max_week_param),
             size=3) + 
  geom_text(data=. %>% filter(week == max_week_param),
            aes(x=week + 1,
                label=passer),
            family='Lexend') + 
  geom_hline(yintercept = 0, color='black', linetype='dashed') + 
  labs(title='EPA per dropback of 1st round rookies in 2024',
       subtitle = glue('Through Week {max_week_param}'),
       caption = 'Source: {nflverse} package<br>Minimum 10 attempts to qualify as a full game',
       x='Week',
       y='EPA/dropback') + 
  theme_nfl_analytics() +
  # theme(legend.position = 'top') + 
  scale_color_nfl(type='secondary')
  # theme(axis.title.y = element_text(angle=0))
```


```{r}
pbp_2024 %>% 
  # filter(passer %in% c('J.Daniels', 'C.Williams', 'B.Nix', 'D.Maye')) %>% 
  filter(!is.na(passer)) %>% 
  group_by(posteam, passer, passer_id) %>% 
  summarise(across(
    c('qb_epa', 'pass_attempt', 'air_epa', 'yac_epa'),
    list(
        mean = ~round(mean(., na.rm = TRUE), 5),
        sum = ~round(sum(., na.rm = TRUE), 5)
      ),
      .names = "{.fn}_{.col}"
    ),
    .groups = 'drop') %>% 
  filter(sum_pass_attempt >= 175) %>% 
  mutate(rank_qb_epa = rank(-mean_qb_epa)) %>% 
  filter(passer %in% c('J.Daniels', 'C.Williams', 'B.Nix', 'D.Maye')) %>%
  ggplot(.,
         aes(y=reorder(passer_id, mean_qb_epa),
             x=mean_qb_epa)) + 
  geom_col(aes(fill = if_else(mean_qb_epa >= 0,
                              '#81fd02', '#8f55e5')),
           width = 0.1) + 
  ggrepel::geom_text_repel(aes(x=mean_qb_epa,
                               label = glue('NFL rank: {rank_qb_epa}')), 
                           family='Lexend') + 
  labs(y='',
       x='EPA per dropback',
       title='EPA per dropback among rookie 1st-rounders in 2024', 
       subtitle=glue('Through Week {max_week_param}'), 
       caption='Source: {nflverse} package<br>Minimum 175 attempts') + 
  theme_nfl_analytics() + 
  theme(legend.position = 'none',
        axis.text.y = nflplotR::element_nfl_headshot(size = 3))
```

#### Kickoff eval

```{r}
kickoff_99_24 <- load_pbp(seasons = TRUE) %>% 
  filter(play_type == 'kickoff',
         season_type == 'REG')


kickoff_99_24 <- kickoff_99_24 %>%
  mutate(injury = if_else(str_detect(desc, 'injur'), 1, 0),
         injury_head = if_else(str_detect(desc, 'head injury'), 1, 0),
         injury_neck = if_else(str_detect(desc, 'neck injury'), 1, 0))

# what do I want the eval metrics to be?
# touchback
# injury
# return_yards
# kick_distance
# touchback
# kick_distance
# kickoff_inside_twenty
# kickoff_in_endzone
# kickoff_fair_catch
# touchdown

kickoff_vars <- c('touchback', 'return_yards', 'kick_distance', 'kickoff_inside_twenty',
                  'kickoff_in_endzone', 'kickoff_fair_catch', 'return_touchdown',
                  # it appears that injury coding changed and the desc field doesn't list injury type anymore 
                  'injury', 'injury_head', 'injury_neck')


kickoff_rates_99_24 <- kickoff_99_24 %>% 
  group_by(season) %>% 
  summarise(across(kickoff_vars,
                   list(
                     # mean = ~round(mean(., na.rm=TRUE), 5)
                     mean = ~mean(., na.rm=TRUE)
                   ),
                   .names = "{.fn}_{.col}"
                   ),
            .groups = 'drop') %>% 
  mutate(return_rate = 1 - mean_touchback)


plot_kickoff_var <- function(var){
  kickoff_rates_99_24 %>% 
  ggplot(.,
         aes(x=season,
             y= {{ var }})) + 
  geom_col() + 
  geom_mean_lines(data = . %>% filter(season != 2024),
                  aes(y0= {{ var }})) + 
  labs(x='Season',
       title="Evaluating the Impact of the NFL's Dynamic Kickoff Rule in 2024", 
       caption='Source: {nflverse}<br>Mean line excludes 2024 season') + 
  scale_y_continuous(labels = scales::percent_format(),
                     breaks = scales::pretty_breaks()) + 
  scale_x_continuous(breaks = scales::pretty_breaks()) + 
  theme_nfl_analytics()
}

plot_kickoff_var(mean_injury)
```



#### 2 shell and passing down

It doesn't seem like they put up the participation data during the season...

```{r}
participation_2023 <- load_participation(season = 2023)
```


#### Regression of Stroud, Rodgers 

```{r}
player_stats_99_24 <- load_player_stats(seasons = TRUE,
                                       stat_type = 'offense')

season_qbr_06_24 <- nflreadr::load_espn_qbr(seasons = TRUE,
                        summary_type = 'season')

avg_qbr <- season_qbr_06_24 %>% 
  filter(qualified == TRUE,
         season_type == 'Regular') %>% 
  summarise(median_qbr_total = median(qbr_total, na.rm=TRUE),
            .groups = 'drop') %>% 
  pull()



season_qbr_06_24 %>% 
  filter(name_short == 'A. Rodgers',
         season_type == 'Regular') %>% 
  ggplot(.,
         aes(x=season,
             y=qbr_total)) + 
  geom_line() + 
  geom_smooth(se=FALSE) + 
  geom_median_lines(data = season_qbr_06_24 %>% filter(qualified == TRUE,
                                                       season_type == 'Regular'),
                    aes(y0 = qbr_total)) + 
  scale_y_continuous(breaks = scales::pretty_breaks()) + 
  scale_x_continuous(breaks = scales::pretty_breaks()) + 
  theme_nfl_analytics()
```


```{r}
dropback_pbp_08_24 <- load_pbp(seasons = c(2008:2024)) %>% 
  filter(season_type == 'REG',
         !is.na(passer)) %>% 
  group_by(season, passer, posteam) %>% 
  summarise(plays = n(),
            interceptions = sum(interception, na.rm = TRUE),
            sum_qb_epa = sum(qb_epa, na.rm = TRUE),
            sum_air_epa = sum(air_epa, na.rm = TRUE),
            sum_yac_epa = sum(yac_epa, na.rm = TRUE),
            sum_qb_epa_int = sum(qb_epa[interception == 1], na.rm = TRUE),
            sum_qb_epa_sack = sum(qb_epa[sack == 1], na.rm = TRUE),
            sum_qb_epa_dpi = sum(qb_epa[penalty_type == 'Defensive Pass Interference'], na.rm = TRUE),
            sum_qb_epa_scramble = sum(qb_epa[qb_scramble == 1], na.rm = TRUE),
            .groups = 'drop') %>% 
  filter(plays >= 150) %>% 
  mutate(
    across(
      starts_with("sum"),
      list(
        mean_centered = ~. - mean(., na.rm = TRUE)
      ),
      .names = "{.fn}_{.col}"
    ))

dropback_pbp_08_24 %>% 
  filter(season == 2020) %>% 
  arrange(-sum_qb_epa)
```





```{r}
dropback_pbp_08_24 %>% 
  summarise(across(starts_with('mean_centered'),
            list(
              max = ~max(., na.rm = TRUE),
              abs_min = ~abs(min(., na.rm = TRUE))
            ),
            .names = "{.fn}_{.col}")
  )
```


```{r}
dropback_pbp_08_24 %>% 
  filter(passer == 'A.Rodgers',
         season != 2023) %>% 
  left_join(x=.,
            y=teams %>% select(team_abbr, team_logo_wikipedia),
            by=c('posteam' = 'team_abbr')) %>% 
  select(season, team_logo_wikipedia, plays, contains('mean_centered')) %>% 
  arrange(-season) %>% 
  gt() %>% 
  cols_label(season = 'Season',
             team_logo_wikipedia = 'Team',
             plays = 'Plays',
             mean_centered_sum_qb_epa = 'EPA',
             mean_centered_sum_air_epa = 'Air',
             mean_centered_sum_yac_epa = 'YAC',
             mean_centered_sum_qb_epa_int = 'INTs',
             mean_centered_sum_qb_epa_sack = 'Sacks',
             mean_centered_sum_qb_epa_dpi = 'DPI',
             mean_centered_sum_qb_epa_scramble = 'Scramble') %>% 
  gt_color_pills(mean_centered_sum_qb_epa, digits = 3,
                 domain = c(-230, 230)) %>% 
  gt_color_pills(mean_centered_sum_air_epa, digits = 3,
                 domain = c(-300, 300)) %>% 
  gt_color_pills(mean_centered_sum_yac_epa, digits = 3,
                 domain = c(-240, 240)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_int, digits = 3,
                 domain = c(-110, 110)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_sack, digits = 3,
                 domain = c(-60, 60)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_dpi, digits = 3,
                 domain = c(-30, 30)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_scramble, digits = 3,
                 domain = c(-50, 50)) %>% 
  tab_header(title = md("**Aaron Rodgers** career EPA data by season"),
             subtitle = md("*Centering EPA categories on the league average to assess how Rodgers has succeeded historically*<br>Highlighting 2014, 2020, and 2021 as his MVP seasons")) %>% 
  tab_source_note(source_note = md("**Source**: {nflverse}<br>Minimum 150 snaps in a season for QBs to qualify<br>Excluding 2023 as injury-shortened season")) %>% 
  tab_style(
    style = list(
      cell_fill(color = "lightgray"),
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      rows = season %in% c(2014, 2020, 2021)
    )
  ) %>% 
  tab_spanner(
    label = md("**Mean Centered**<br>Positive values indicate performance above league average in that season"),    
    columns = c(mean_centered_sum_qb_epa:mean_centered_sum_qb_epa_scramble)
  ) %>% 
  gt_img_rows(
    columns = team_logo_wikipedia,
    height = 30
  ) %>% 
  gt_theme_athletic()
```


So what is clearly *not* working this year? Well, lots of things -- the Jets are a mess. But throughout Rodgers' career, two things stand out:

*  **Air EPA** was a strength of his game. He could push the ball down the field and add value to his team by completing passes that improve his team's expected points. Only in 2013 and 2017 -- both injury-shortened seasons -- did Rodgers post air EPA numbers below the league average. In 2024, his offense is more reliant on yards after the catch than in most of his career.
*  Rodgers has always posted above average EPA from **scrambles**, and this is the first season where that doesn't hold true. Whether it's the injury or just a reluctance to run, Rodgers is simply more stationary and less effective at scrambling at this stage in his career.

```{r qb_epa_mean_centered_gt, include=TRUE, warning=FALSE, results='asis'}
passing_epa_2024 %>% 
  select(passer, posteam, plays, contains('mean_centered'), -mean_centered_sum_qb_epa_incomplete) %>% 
  arrange(-mean_centered_sum_qb_epa) %>% 
  gt() %>% 
  cols_label(passer = 'Name',
             posteam = 'Team',
             plays = 'Plays',
             mean_centered_sum_qb_epa = 'EPA',
             mean_centered_sum_qb_epa_drops = 'Drops',
             mean_centered_sum_qb_epa_int = 'INTs',
             mean_centered_sum_qb_epa_sack = 'Sacks',
             mean_centered_sum_qb_epa_dpi = 'DPI') %>% 
  gt_theme_athletic()
```


#### Lamar and another MVP campaign -- how has his game evolved?

```{r}
dropback_pbp_08_24 %>% 
  filter(season == 2024) %>% 
  arrange(-sum_qb_epa_scramble)
```


```{r}
dropback_pbp_08_24 %>% 
  filter(season >= 2018,
         passer == 'L.Jackson') %>% 
  left_join(x=.,
            y=teams %>% select(team_abbr, team_logo_wikipedia),
            by=c('posteam' = 'team_abbr')) %>% 
  select(season, team_logo_wikipedia, plays, contains('mean_centered')) %>% 
  arrange(-season) %>% 
  gt() %>% 
  cols_label(season = 'Season',
             team_logo_wikipedia = 'Team',
             plays = 'Plays',
             mean_centered_sum_qb_epa = 'EPA',
             mean_centered_sum_air_epa = 'Air',
             mean_centered_sum_yac_epa = 'YAC',
             mean_centered_sum_qb_epa_int = 'INTs',
             mean_centered_sum_qb_epa_sack = 'Sacks',
             mean_centered_sum_qb_epa_dpi = 'DPI',
             mean_centered_sum_qb_epa_scramble = 'Scramble') %>% 
  gt_color_pills(mean_centered_sum_qb_epa, digits = 3,
                 domain = c(-230, 230)) %>% 
  gt_color_pills(mean_centered_sum_air_epa, digits = 3,
                 domain = c(-300, 300)) %>% 
  gt_color_pills(mean_centered_sum_yac_epa, digits = 3,
                 domain = c(-240, 240)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_int, digits = 3,
                 domain = c(-110, 110)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_sack, digits = 3,
                 domain = c(-60, 60)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_dpi, digits = 3,
                 domain = c(-30, 30)) %>% 
  gt_color_pills(mean_centered_sum_qb_epa_scramble, digits = 3,
                 domain = c(-50, 50)) %>% 
  tab_header(title = md("The Evolution of **Lamar Jackson**"),
             subtitle = md("*Centering EPA categories on the league average to assess how Jackson has succeeded historically*<br>Highlighting 2019 and 2023 as his MVP seasons")) %>% 
  tab_source_note(source_note = md("**Source**: {nflverse}<br>Minimum 150 snaps in a season for QBs to qualify")) %>% 
  tab_style(
    style = list(
      cell_fill(color = "lightgray"),
      cell_text(weight = "bold")
    ),
    locations = cells_body(
      rows = season %in% c(2019, 2023)
    )
  ) %>% 
  tab_spanner(
    label = md("**Mean Centered**<br>Positive values indicate performance above league average in that season"),    
    columns = c(mean_centered_sum_qb_epa:mean_centered_sum_qb_epa_dpi)           # Columns to span
  ) %>% 
  gt_img_rows(
    columns = team_logo_wikipedia,
    height = 30
  ) %>% 
  gt_theme_athletic()
```


Conventional thought is that Jackson's scrambling is the strength in his game. While it's true that his scrambling ability is *a* strength, he's performing at about the league average from an EPA standpoint. In 2024, the majority of his rushing yards have come from designed QB runs. (**Look up RPO from FTN**)

```{r}
pbp_2024 %>% 
  # select(contains('rush'))
  filter(play_type == 'run',
         rusher_player_name == 'L.Jackson') %>% 
  group_by(qb_scramble) %>% 
  summarise(yards = sum(yards_gained, na.rm = TRUE))
  filter(passer == 'L.Jackson')
```


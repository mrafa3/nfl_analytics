---
title: "NFL Analytics: top high-leverage plays"
output: html_notebook
---

```{r libraries, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(nflverse)
library(gt)
library(ggtext)
library(ggrepel)
library(patchwork)
library(ggimage)
```

```{r nfl_analytics_theme, include=TRUE}
nfl_analytics_theme <- function(..., base_size = 12) {
  
  theme(
    text = element_text(family = "Roboto",
                        size = base_size,
                        color = "black"),
    axis.ticks = element_blank(),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold"),
    plot.title.position = "plot",
    plot.title = element_markdown(size = 16,
                                  vjust = .02,
                                  hjust = 0.5),
    plot.subtitle = element_markdown(hjust = 0.5),
    plot.caption = element_markdown(size = 8),
    panel.grid.minor = element_blank(),
    panel.grid.major =  element_line(color = "#d0d0d0"),
    panel.background = element_rect(fill = "#f7f7f7"),
    plot.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_blank(),
    legend.background = element_rect(color = "#F7F7F7"),
    legend.key = element_rect(color = "#F7F7F7"),
    legend.title = element_text(face = "bold"),
    legend.title.align = 0.5,
    strip.text = element_text(face = "bold"))
}
```

```{r teams, include=TRUE}
teams <- nflreadr::load_teams()
```

# Data 

```{r play_by_play_2024, include=TRUE}
play_by_play_2024 <- nflreadr::load_pbp(seasons = most_recent_season())
```

```{r}
play_by_play_2024 %>% 
  filter(game_id == '2024_06_JAX_CHI') %>% 
  # filter(game_id == '2024_06_PIT_LV') %>% 
  mutate(down_dist = paste(down, ydstogo, sep = '-'),
         score = paste(total_away_score, total_home_score, sep = '-'), 
         play_type = case_when(play_type == 'pass' ~ 'Pass',
                               play_type == 'run' ~ 'Run',
                               play_type == 'field_goal' ~ 'FG',
                               TRUE ~ 'Other'), 
         abs_epa = abs(epa),
         wp_chg = abs(lead(wp) - wp)) %>% 
  # mutate(,
  #        epa_chg = abs(lead(epa) - epa)) %>% 
  arrange(-abs_epa) %>% 
  # select(contains('yds'))
  select(posteam, qtr, time, down_dist, score, play_type,
         desc, ydsnet, wp_chg, epa)
  select(epa, abs_epa, desc, everything())
```


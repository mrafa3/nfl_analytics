---
title: "Defensive Advanced Stats: EPA per play vs Success Rate"
output: html_notebook
---

```{r libraries, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(nflverse)
library(gt)
library(gtExtras)
library(gtUtils)
library(ggtext)
library(ggrepel)
library(patchwork)
library(ggimage)
```

```{r nfl_analytics_theme, include=TRUE}
nfl_analytics_theme <- function(..., base_size = 12) {
  
  theme(
    text = element_text(family = "Lexend",
                        size = base_size,
                        color = "black"),
    axis.ticks = element_blank(),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(face = "bold"),
    plot.title.position = "plot",
    plot.title = element_markdown(size = 16,
                                  vjust = .02,
                                  hjust = 0.5),
    plot.subtitle = element_markdown(hjust = 0.5),
    plot.caption = element_markdown(size = 8),
    panel.grid.minor = element_blank(),
    panel.grid.major =  element_line(color = "#d0d0d0"),
    panel.background = element_rect(fill = "#f7f7f7"),
    plot.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_blank(),
    legend.background = element_rect(color = "#F7F7F7"),
    legend.key = element_rect(color = "#F7F7F7"),
    legend.title = element_text(face = "bold", hjust = .5),
    strip.text = element_text(face = "bold"))
}
```

```{r teams, include=TRUE}
teams <- nflreadr::load_teams(current = TRUE)
```

```{r play_by_play_2024, include=TRUE}
play_by_play_2024 <- load_pbp(seasons = most_recent_season())
```
```{r defensive_epa_success, include=TRUE}
defensive_epa_success <- play_by_play_2024 %>% 
  filter(special != 1,
         # this removes no play situations resulting from penalties
         play_type %in% c('run', 'pass')) %>% 
  group_by(defteam) %>%
  summarise(sum_epa = sum(epa, na.rm = TRUE),
            plays = n(),
            def_success = 1 - mean(success, na.rm = TRUE), 
            .groups = 'drop') %>% 
  mutate(epa_per_play = sum_epa / plays,
         rank_epa_per_play = rank(epa_per_play),
         rank_def_success = rank(-def_success)) %>% 
  arrange(epa_per_play)
```

```{r turnovers, include=TRUE}
# Turnovers can happen on special teams and other play types, so the above filter misses those
# I'm still missing something in the logic, according to footballdb.com the Vikings have 15 after 7 games, not 16
turnovers <- play_by_play_2024 %>% 
  filter(!is.na(defteam)) %>% 
  group_by(defteam) %>% 
  summarise(interceptions = sum(interception, na.rm = TRUE),
            fumbles = sum(fumble_lost, na.rm = TRUE),
            .groups = 'drop') %>% 
  mutate(ttl_turnovers = interceptions + fumbles) %>% 
  arrange(-ttl_turnovers)
```

```{r defensive_epa_success_join_teams, include=TRUE}
(defensive_epa_success <- defensive_epa_success %>% 
  left_join(x=.,
            y=teams,
            by=c('defteam' = 'team_abbr')))
```


```{r defensive_epa_success_plot, include=TRUE}
defensive_epa_success %>% 
  ggplot(.,
         aes(x=def_success,
             y=epa_per_play)) + 
  # geom_point() + 
  geom_mean_lines(aes(x0=def_success,
                      y0=epa_per_play),
                  color='black', linewidth=.8, linetype='dashed') + 
  geom_image(aes(image = team_logo_wikipedia), size=.1) +
  scale_x_continuous(breaks = scales::pretty_breaks(),
                     labels = scales::percent_format()) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  nfl_analytics_theme()
```

